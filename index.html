<!DOCTYPE html>
<html lang="pt-PT">
<head>
Â  <meta charset="UTF-8" />
Â  <title>Generate Report</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <style>
Â  Â  :root {
Â  Â  Â  --primary: #007c91;
Â  Â  Â  --primary-soft: #e0f4f7;
Â  Â  Â  --bg: #f3f7f9;
Â  Â  Â  --card: #ffffff;
Â  Â  Â  --border: #dde5ec;
Â  Â  Â  --radius: 10px;
Â  Â  Â  --shadow-soft: 0 12px 30px rgba(15, 52, 67, 0.08);
Â  Â  Â  --text-main: #123047;
Â  Â  Â  --text-muted: #6b7a88;
Â  Â  Â  --red: #e74c3c;
Â  Â  }

Â  Â  * { box-sizing: border-box; font-family: 'Inter', sans-serif; }

Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 32px 16px 40px;
Â  Â  Â  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
Â  Â  Â  background: radial-gradient(circle at top, #e5f5ff 0, #f5fafc 45%, #f3f7f9 100%);
Â  Â  Â  color: var(--text-main);
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  min-height: 100vh;
Â  Â  }

Â  Â  .shell {
Â  Â  Â  width: 100%;
Â  Â  Â  max-width: 1120px;
Â  Â  }

Â  Â  header h1 {
Â  Â  Â  margin: 0 0 4px;
Â  Â  Â  font-size: 26px;
Â  Â  Â  letter-spacing: 0.04em;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  border-bottom: 2px solid var(--primary);
Â  Â  Â  padding-bottom: 8px;
Â  Â  }

Â  Â  header p {
Â  Â  Â  margin: 8px 0 22px;
Â  Â  Â  font-size: 13px;
Â  Â  Â  color: var(--text-muted);
Â  Â  }

Â  Â  .grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: 1.1fr 1fr 1.1fr;
Â  Â  Â  gap: 18px;
Â  Â  }

Â  Â  .card {
Â  Â  Â  background: var(--card);
Â  Â  Â  border-radius: 18px;
Â  Â  Â  box-shadow: var(--shadow-soft);
Â  Â  Â  padding: 16px 16px 10px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  min-height: 240px;
Â  Â  Â  max-height: 300px;
Â  Â  }

Â  Â  .card-header {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 6px;
Â  Â  }

Â  Â  .card-title {
Â  Â  Â  font-size: 13px;
Â  Â  Â  letter-spacing: 0.12em;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  color: var(--primary);
Â  Â  }

Â  Â  .helper-text {
Â  Â  Â  font-size: 11px;
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  margin: 0 2px 6px;
Â  Â  }

Â  Â  .list {
Â  Â  Â  margin-top: 4px;
Â  Â  Â  padding: 4px 4px 4px 0;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  flex: 1;
Â  Â  }

Â  Â  .item {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  gap: 6px;
Â  Â  Â  padding: 4px 6px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  font-size: 13px;
Â  Â  }

Â  Â  .item:hover { background: #f2f7fb; }

Â  Â  .item-main {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 6px;
Â  Â  Â  flex: 1;
Â  Â  Â  min-width: 0;
Â  Â  }

Â  Â  .item label {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 6px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  width: 100%;
Â  Â  }

Â  Â  .item span.text {
Â  Â  Â  white-space: nowrap;
Â  Â  Â  overflow: hidden;
Â  Â  Â  text-overflow: ellipsis;
Â  Â  }

Â  Â  input[type="checkbox"] {
Â  Â  Â  width: 16px;
Â  Â  Â  height: 16px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  accent-color: var(--primary);
Â  Â  }

Â  Â  .chip-archive {
Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  border-radius: 999px;
Â  Â  Â  padding: 0 10px;
Â  Â  Â  font-size: 11px;
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  background: #f6fafc;
Â  Â  Â  cursor: pointer;
Â  Â  Â  flex-shrink: 0;
Â  Â  Â  transition: all 0.2s ease;
Â  Â  }
Â  Â  .chip-archive:hover {
Â  Â  Â  border-color: var(--primary);
Â  Â  Â  color: var(--primary);
Â  Â  Â  background: var(--primary-soft);
Â  Â  }

Â  Â  .btn-ghost {
Â  Â  Â  border-radius: 999px;
Â  Â  Â  border: 1px solid var(--primary-soft);
Â  Â  Â  padding: 4px 10px;
Â  Â  Â  font-size: 11px;
Â  Â  Â  background: #f5fafb;
Â  Â  Â  color: var(--primary);
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.2s ease;
Â  Â  }
Â  Â  .btn-ghost:hover { background: var(--primary-soft); }

Â  Â  /* Blocos dinÃ¢micos (Formador / InÃ­cio / Fim / Turmas) */
Â  Â  #dynamicBlocks {
Â  Â  Â  margin-top: 18px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 12px;
Â  Â  }

Â  Â  .dynamic-block {
Â  Â  Â  background: var(--card);
Â  Â  Â  border-radius: 14px;
Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  box-shadow: var(--shadow-soft);
Â  Â  Â  padding: 14px 16px 12px;
Â  Â  }

Â  Â  .dynamic-block h3 {
Â  Â  Â  margin: 0 0 10px;
Â  Â  Â  font-size: 15px;
Â  Â  Â  color: var(--primary);
Â  Â  }

Â  Â  .dynamic-block h4 {
Â  Â  Â  margin: 10px 0 6px;
Â  Â  Â  font-size: 13px;
Â  Â  Â  color: var(--primary);
Â  Â  }

Â  Â  .dynamic-block label {
Â  Â  Â  display: block;
Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  color: var(--text-main);
Â  Â  }

Â  Â  .dynamic-block input[type="text"],
Â  Â  .dynamic-block input[type="month"] {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 6px 8px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  font-size: 13px;
Â  Â  Â  margin-bottom: 6px;
Â  Â  }

Â  Â  .dynamic-block ol {
Â  Â  Â  margin: 0;
Â  Â  Â  padding-left: 16px;
Â  Â  Â  list-style: none;
Â  Â  Â  max-height: 120px;
Â  Â  Â  overflow-y: auto;
Â  Â  }

Â  Â  .dynamic-block ol li {
Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  font-size: 13px;
Â  Â  }

Â  Â  .dynamic-block ol label {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 6px;
Â  Â  Â  margin: 0;
Â  Â  Â  font-weight: normal;
Â  Â  }

Â  Â  .dynamic-block input[type="checkbox"] { margin-right: 4px; }

Â  Â  /* Barra inferior */
Â  Â  .footer-bar {
Â  Â  Â  margin-top: 18px;
Â  Â  Â  background: rgba(255, 255, 255, 0.85);
Â  Â  Â  border-radius: 999px;
Â  Â  Â  box-shadow: 0 10px 26px rgba(15, 52, 67, 0.09);
Â  Â  Â  padding: 10px 18px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  gap: 12px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  color: var(--text-muted);
Â  Â  Â  position: sticky; /* Sticky footer for better UX */
Â  Â  Â  bottom: 0;
Â  Â  Â  backdrop-filter: blur(5px);
Â  Â  Â  z-index: 10;
Â  Â  }

Â  Â  .footer-left {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 8px;
Â  Â  }

Â  Â  .pill-archived {
Â  Â  Â  border-radius: 999px;
Â  Â  Â  padding: 4px 10px;
Â  Â  Â  background: #f1f6f9;
Â  Â  Â  border: 1px solid #d8e4ee;
Â  Â  Â  display: inline-flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 6px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.2s ease;
Â  Â  }
Â  Â  .pill-archived:hover { background: var(--primary-soft); border-color: var(--primary); }

Â  Â  .badge-count {
Â  Â  Â  border-radius: 999px;
Â  Â  Â  padding: 2px 7px;
Â  Â  Â  font-size: 10px;
Â  Â  Â  background: var(--primary-soft);
Â  Â  Â  color: var(--primary);
Â  Â  }

Â  Â  .btn-primary {
Â  Â  Â  border-radius: 999px;
Â  Â  Â  padding: 8px 22px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  border: none;
Â  Â  Â  cursor: pointer;
Â  Â  Â  background: #9aa4af;
Â  Â  Â  color: white;
Â  Â  Â  transition: all 0.2s ease;
Â  Â  }
Â  Â  .btn-primary.enabled {
Â  Â  Â  background: var(--primary);
Â  Â  Â  box-shadow: 0 8px 18px rgba(0, 124, 145, 0.35);
Â  Â  }
Â  Â  .btn-primary.enabled:hover { background: #006173; }

Â  Â  /* Painel arquivados */
Â  Â  .archived-panel {
Â  Â  Â  position: fixed; /* Fixed position */
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  bottom: 70px;
Â  Â  Â  min-width: 420px;
Â  Â  Â  max-width: 620px;
Â  Â  Â  background: #ffffff;
Â  Â  Â  border-radius: 14px;
Â  Â  Â  box-shadow: 0 18px 40px rgba(15, 52, 67, 0.18);
Â  Â  Â  padding: 14px 16px 12px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  color: var(--text-main);
Â  Â  Â  display: none;
Â  Â  Â  z-index: 20;
Â  Â  }
Â  Â  .archived-panel.visible { display: block; }

Â  Â  .archived-panel h4 {
Â  Â  Â  margin: 0 0 6px;
Â  Â  Â  font-size: 13px;
Â  Â  Â  color: var(--primary);
Â  Â  }

Â  Â  .archived-list-group { margin-bottom: 6px; }

Â  Â  .archived-list-group strong {
Â  Â  Â  font-size: 11px;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  letter-spacing: 0.08em;
Â  Â  Â  color: var(--text-muted);
Â  Â  }

Â  Â  .archived-tags {
Â  Â  Â  margin-top: 4px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 6px;
Â  Â  }

Â  Â  .tag {
Â  Â  Â  border-radius: 999px;
Â  Â  Â  padding: 3px 8px;
Â  Â  Â  background: #f3f7fb;
Â  Â  Â  border: 1px solid #d9e4f0;
Â  Â  Â  font-size: 11px;
Â  Â  }

Â  Â  .tag span {
Â  Â  Â  margin-left: 4px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  color: var(--red);
Â  Â  Â  font-weight: bold;
Â  Â  }

Â  Â  /* Custom Modal/Message Box */
Â  Â  .modal-overlay {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background: rgba(0, 0, 0, 0.4);
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  z-index: 100;
Â  Â  Â  transition: opacity 0.3s ease;
Â  Â  Â  opacity: 0;
Â  Â  Â  pointer-events: none;
Â  Â  }
Â  Â  .modal-overlay.active { opacity: 1; pointer-events: auto; }

Â  Â  .modal-content {
Â  Â  Â  background: white;
Â  Â  Â  padding: 20px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
Â  Â  Â  max-width: 400px;
Â  Â  Â  width: 90%;
Â  Â  Â  text-align: center;
Â  Â  Â  transform: translateY(-20px);
Â  Â  Â  transition: transform 0.3s ease, opacity 0.3s ease;
Â  Â  Â  opacity: 0;
Â  Â  }
Â  Â  .modal-overlay.active .modal-content { transform: translateY(0); opacity: 1; }

Â  Â  .modal-title {
Â  Â  Â  font-size: 18px;
Â  Â  Â  color: var(--primary);
Â  Â  Â  margin-bottom: 10px;
Â  Â  }

Â  Â  .modal-message {
Â  Â  Â  font-size: 14px;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  color: var(--text-main);
Â  Â  }

Â  Â  .modal-buttons button {
Â  Â  Â  padding: 8px 16px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  margin: 0 5px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  border: 1px solid var(--primary);
Â  Â  Â  transition: all 0.2s ease;
Â  Â  }

Â  Â  .modal-confirm-btn {
Â  Â  Â  background: var(--primary);
Â  Â  Â  color: white;
Â  Â  }
Â  Â  .modal-confirm-btn:hover { background: #006173; }

Â  Â  .modal-cancel-btn, .modal-ok-btn {
Â  Â  Â  background: white;
Â  Â  Â  color: var(--primary);
Â  Â  }
Â  Â  .modal-cancel-btn:hover, .modal-ok-btn:hover { background: var(--primary-soft); }

Â  Â  @media (max-width: 960px) {
Â  Â  Â  .grid { grid-template-columns: 1fr; }
Â  Â  Â  .card { max-height: none; }
Â  Â  Â  .archived-panel {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  left: 12px;
Â  Â  Â  Â  right: 12px;
Â  Â  Â  Â  transform: none;
Â  Â  Â  Â  bottom: 82px;
Â  Â  Â  Â  max-width: none;
Â  Â  Â  }
Â  Â  }
Â  </style>
</head>
<body>
Â  <div class="shell">
Â  Â  <header>
Â  Â  Â  <h1>GENERATE REPORT</h1>
Â  Â  Â  <p>
Â  Â  Â  Â  Escolhe o cliente, o(s) programa(s) e a informaÃ§Ã£o pretendida. Podes arquivar clientes / programas / infos
Â  Â  Â  Â  para manter a lista limpa.
Â  Â  Â  </p>
Â  Â  </header>

Â  Â  <div class="grid">
Â  Â  Â  <!-- CLIENTES -->
Â  Â  Â  <section class="card" id="card-clients">
Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  <span class="card-title">Cliente</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p class="helper-text">Seleciona exatamente um cliente.</p>
Â  Â  Â  Â  <div class="list" id="clientList"></div>
Â  Â  Â  </section>

Â  Â  Â  <!-- PROGRAMAS -->
Â  Â  Â  <section class="card" id="card-programs">
Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  <span class="card-title">Programas</span>
Â  Â  Â  Â  Â  <button class="btn-ghost" id="btnSelectAllPrograms">Selecionar todos</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p class="helper-text">Escolhe um ou mais programas para o cliente selecionado.</p>
Â  Â  Â  Â  <div class="list" id="programList"></div>
Â  Â  Â  </section>

Â  Â  Â  <!-- INFOS -->
Â  Â  Â  <section class="card" id="card-infos">
Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  <span class="card-title">Data / Info</span>
Â  Â  Â  Â  Â  <button class="btn-ghost" id="btnSelectAllInfos">Selecionar todos</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p class="helper-text">Filtra anos, turmas ou outras infos conforme os dados.</p>
Â  Â  Â  Â  <div class="list" id="infoList"></div>
Â  Â  Â  </section>
Â  Â  </div>

Â  Â  <!-- Blocos dinÃ¢micos por programa -->
Â  Â  <div id="dynamicBlocks"></div>

Â  Â  <!-- Barra inferior -->
Â  Â  <div class="footer-bar">
Â  Â  Â  <div class="footer-left">
Â  Â  Â  Â  <div class="pill-archived" id="btnToggleArchivedPill">
Â  Â  Â  Â  Â  <span>ðŸ”’ Arquivados</span>
Â  Â  Â  Â  Â  <span id="archivedCount" class="badge-count">0</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <span id="archivedHelper">Guardado no Apps Script (partilhado entre utilizadores).</span>
Â  Â  Â  </div>

Â  Â  Â  <div style="display:flex; align-items:center; gap:10px;">
Â  Â  Â  Â  <button class="btn-ghost" id="btnToggleArchived">Ver arquivados â–¾</button>
Â  Â  Â  Â  <button id="viewReport" class="btn-primary" disabled>Ver relatÃ³rio</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Painel de arquivados -->
Â  Â  <div id="archivedPanel" class="archived-panel">
Â  Â  Â  <h4>Itens arquivados</h4>

Â  Â  Â  <!-- filtro por cliente -->
Â  Â  Â  <div style="margin-bottom:8px; display:flex; gap:6px; align-items:center;">
Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  id="archivedFilter"
Â  Â  Â  Â  Â  type="text"
Â  Â  Â  Â  Â  placeholder="Filtrar por cliente..."
Â  Â  Â  Â  Â  style="flex:1; padding:4px 8px; font-size:11px; border-radius:6px; border:1px solid #d1dde8;"
Â  Â  Â  Â  />
Â  Â  Â  </div>

Â  Â  Â  <div id="archivedContent"></div>
Â  Â  Â  <p style="margin:6px 0 0; font-size:11px; color:var(--text-muted);">
Â  Â  Â  Â  Nota: remover dos arquivados volta a mostrar o item nas listas acima.
Â  Â  Â  </p>
Â  Â  </div>

Â  Â  <!-- Custom Modal UI (ConfirmaÃ§Ã£o e Mensagem) -->
Â  Â  <div id="customModal" class="modal-overlay">
Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  <div class="modal-title" id="modalTitle"></div>
Â  Â  Â  Â  <div class="modal-message" id="modalMessage"></div>
Â  Â  Â  Â  <div class="modal-buttons" id="modalButtons"></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  </div>

Â  <script>
Â  Â  // ====================================================
Â  Â  // CUSTOM MODAL (Substitui alert() e confirm())
Â  Â  // ====================================================

Â  Â  // FunÃ§Ã£o principal para mostrar o modal
Â  Â  function showModal(title, message, type, onConfirm) {
Â  Â  Â  const modal = document.getElementById('customModal');
Â  Â  Â  const modalTitle = document.getElementById('modalTitle');
Â  Â  Â  const modalMessage = document.getElementById('modalMessage');
Â  Â  Â  const modalButtons = document.getElementById('modalButtons');

Â  Â  Â  modalTitle.textContent = title;
Â  Â  Â  modalMessage.textContent = message;
Â  Â  Â  modalButtons.innerHTML = '';

Â  Â  Â  if (type === 'confirm') {
Â  Â  Â  Â  const confirmBtn = document.createElement('button');
Â  Â  Â  Â  confirmBtn.className = 'modal-confirm-btn';
Â  Â  Â  Â  confirmBtn.textContent = 'Sim, Arquivar';
Â  Â  Â  Â  confirmBtn.onclick = () => {
Â  Â  Â  Â  Â  onConfirm(true);
Â  Â  Â  Â  Â  modal.classList.remove('active');
Â  Â  Â  Â  };

Â  Â  Â  Â  const cancelBtn = document.createElement('button');
Â  Â  Â  Â  cancelBtn.className = 'modal-cancel-btn';
Â  Â  Â  Â  cancelBtn.textContent = 'Cancelar';
Â  Â  Â  Â  cancelBtn.onclick = () => {
Â  Â  Â  Â  Â  onConfirm(false);
Â  Â  Â  Â  Â  modal.classList.remove('active');
Â  Â  Â  Â  };

Â  Â  Â  Â  modalButtons.append(cancelBtn, confirmBtn);
Â  Â  Â  } else { // 'alert' or 'message'
Â  Â  Â  Â  const okBtn = document.createElement('button');
Â  Â  Â  Â  okBtn.className = 'modal-ok-btn';
Â  Â  Â  Â  okBtn.textContent = 'OK';
Â  Â  Â  Â  okBtn.onclick = () => modal.classList.remove('active');
Â  Â  Â  Â  modalButtons.appendChild(okBtn);
Â  Â  Â  }

Â  Â  Â  // Timeout para garantir que o modal aparece acima da barra de rodapÃ© (z-index)
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  modal.classList.add('active');
Â  Â  Â  }, 10);
Â  Â  }

Â  Â  // Helpers
Â  Â  function customAlert(title, message) {
Â  Â  Â  showModal(title, message, 'alert');
Â  Â  }

Â  Â  function customConfirm(title, message, callback) {
Â  Â  Â  showModal(title, message, 'confirm', callback);
Â  Â  }


Â  Â  // ====================================================
Â  Â  // CONFIG: URL do Apps Script (Web App, termina em /exec)
Â  Â  // Ã‰ usado para guardar o estado de arquivado de forma partilhada.
Â  Â  // ====================================================
Â  Â  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz54-DuWj1knZ4eoreDANYPOzbtRMqeFtxt1NV2vi3u0QLuDbi4mt66bNOgeSJstWKWJA/exec';

Â  Â  // ====================================================
Â  Â  // NOVO: CONFIGURAÃ‡ÃƒO DE CSV DINÃ‚MICO
Â  Â  // ====================================================
Â  Â  // Insira aqui o URL do ficheiro CSV publicado (File > Share > Publish to web > CSV)
Â  Â  // Se deixar vazio, serÃ£o usadas as perguntas padrÃ£o abaixo.
Â  Â  const IGNORED_QUESTIONS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQugAUvNS81Ey6C4jjgFAjgGpDyrvnKsEFdnmywCG5NU6faRPm9_XPiZBTtTyYzQPLNr7LK2F2SOz2O/pubhtml?gid=289711789&single=true'; 

Â  Â  // ====================================================
Â  Â  // CONSTANTES DE FILTRAGEM (PERGUNTAS A IGNORAR)
Â  Â  // ====================================================
Â  Â  // Lista padrÃ£o (fallback) caso o CSV nÃ£o esteja configurado ou falhe
Â  Â  let PERGUNTAS_IGNORADAS = [
Â  Â  Â  'Carimbo de data/hora',
Â  Â  Â  'Nome de utilizador',
Â  Â  Â  'EndereÃ§o de email',
Â  Â  Â  'PontuaÃ§Ã£o'
Â  Â  ];

Â  Â  // ====================================================
Â  Â  // ESTADO
Â  Â  // ====================================================
Â  Â  let data = [];
Â  Â  let archived = { clients: {}, programs: {}, infos: {} };

Â  Â  // Filtros (como no index antigo)
Â  Â  function loadFilters() {
Â  Â  Â  return JSON.parse(localStorage.getItem('filters') || '{}');
Â  Â  }
Â  Â  function saveFilters(f) {
Â  Â  Â  localStorage.setItem('filters', JSON.stringify(f));
Â  Â  }
Â  Â  function updateFilter(key, val) {
Â  Â  Â  const f = loadFilters();
Â  Â  Â  f[key] = val;
Â  Â  Â  saveFilters(f);
Â  Â  }

Â  Â  // ====================================================
Â  Â  // CARREGAR LISTA IGNORADA DO CSV
Â  Â  // ====================================================
Â  Â  async function loadIgnoredQuestions() {
Â  Â  Â  if (!IGNORED_QUESTIONS_CSV_URL || IGNORED_QUESTIONS_CSV_URL.trim() === '') {
Â  Â  Â  Â  console.log('CSV URL de perguntas ignoradas nÃ£o definido. A usar defaults.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(IGNORED_QUESTIONS_CSV_URL);
Â  Â  Â  Â  if (!res.ok) throw new Error('Falha ao aceder ao CSV: ' + res.status);
Â  Â  Â  Â  const text = await res.text();
Â  Â  Â  Â  
Â  Â  Â  Â  // Assume que cada linha Ã© uma pergunta a ignorar
Â  Â  Â  Â  const lines = text.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
Â  Â  Â  Â  
Â  Â  Â  Â  if (lines.length > 0) {
Â  Â  Â  Â  Â  PERGUNTAS_IGNORADAS = lines;
Â  Â  Â  Â  Â  console.log('Perguntas ignoradas atualizadas via CSV:', PERGUNTAS_IGNORADAS);
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.warn('Erro ao carregar CSV de perguntas ignoradas (mantendo defaults):', err);
Â  Â  Â  }
Â  Â  }

Â  Â  // ====================================================
Â  Â  // APPS SCRIPT: GET / SET ARQUIVADOS
Â  Â  // ====================================================
Â  Â  async function loadArchivedState() {
Â  Â  Â  // Adicionando uma verificaÃ§Ã£o robusta se a URL nÃ£o for vÃ¡lida
Â  Â  Â  const isValidUrl = APPS_SCRIPT_URL && APPS_SCRIPT_URL.startsWith('http');

Â  Â  Â  if (!isValidUrl) {
Â  Â  Â  Â  console.warn('APPS_SCRIPT_URL invÃ¡lida ou nÃ£o definida. A usar estado arquivado vazio.');
Â  Â  Â  Â  return { clients: {}, programs: {}, infos: {} };
Â  Â  Â  }
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(APPS_SCRIPT_URL + '?action=getArchived', { method: 'GET' });
Â  Â  Â  Â  if (!res.ok) throw new Error('HTTP ' + res.status);
Â  Â  Â  Â  const j = await res.json();
Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  clients: j.clients || {},
Â  Â  Â  Â  Â  programs: j.programs || {},
Â  Â  Â  Â  Â  infos: j.infos || {}
Â  Â  Â  Â  };
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.warn('Erro ao carregar estado arquivado, a usar vazio:', err);
Â  Â  Â  Â  // Apenas mostra a mensagem de erro se a URL for vÃ¡lida (para nÃ£o incomodar se for placeholder)
Â  Â  Â  Â  customAlert('Erro de ComunicaÃ§Ã£o', 'NÃ£o foi possÃ­vel carregar o estado de arquivados do Apps Script. A utilizar listas completas (nÃ£o arquivadas).');
Â  Â  Â  Â  return { clients: {}, programs: {}, infos: {} };
Â  Â  Â  }
Â  Â  }

Â  Â  async function saveArchivedState() {
Â  Â  Â  const isValidUrl = APPS_SCRIPT_URL && APPS_SCRIPT_URL.startsWith('http');
Â  Â  Â  if (!isValidUrl) return;

Â  Â  Â  try {
Â  Â  Â  Â  await fetch(APPS_SCRIPT_URL + '?action=setArchived', {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'text/plain;charset=utf-8' },
Â  Â  Â  Â  Â  body: JSON.stringify(archived)
Â  Â  Â  Â  });
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.warn('Erro ao gravar estado arquivado:', err);
Â  Â  Â  Â  customAlert('Erro de GravaÃ§Ã£o', 'NÃ£o foi possÃ­vel guardar o estado de arquivados no Apps Script.');
Â  Â  Â  }
Â  Â  }

Â  Â  // ====================================================
Â  Â  // RENDER LISTAS
Â  Â  // ====================================================
Â  Â  function getCurrentClient() {
Â  Â  Â  const f = loadFilters();
Â  Â  Â  return (f.clients || [])[0] || null;
Â  Â  }

Â  Â  function renderClients() {
Â  Â  Â  const list = document.getElementById('clientList');
Â  Â  Â  list.innerHTML = '';

Â  Â  Â  const f = loadFilters();
Â  Â  Â  const selected = f.clients || [];

Â  Â  Â  const clients = [...new Set(data.map(r => r.client))].sort();

Â  Â  Â  clients.forEach(client => {
Â  Â  Â  Â  if (archived.clients[client]) return;

Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  item.className = 'item';

Â  Â  Â  Â  const main = document.createElement('div');
Â  Â  Â  Â  main.className = 'item-main';

Â  Â  Â  Â  const label = document.createElement('label');
Â  Â  Â  Â  const cb = document.createElement('input');
Â  Â  Â  Â  cb.type = 'checkbox';
Â  Â  Â  Â  cb.checked = selected.includes(client);

Â  Â  Â  Â  cb.onchange = () => {
Â  Â  Â  Â  Â  const filters = loadFilters();
Â  Â  Â  Â  Â  // Apenas um cliente
Â  Â  Â  Â  Â  if (cb.checked) {
Â  Â  Â  Â  Â  Â  filters.clients = [client];
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  filters.clients = [];
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  // Quando muda de cliente, limpa programas/infos
Â  Â  Â  Â  Â  filters.programs = [];
Â  Â  Â  Â  Â  filters.clientInfos = [];
Â  Â  Â  Â  Â  // Limpa todos os filtros dinÃ¢micos que dependem do cliente (turmas, etc.)
Â  Â  Â  Â  Â  for (const key in filters) {
Â  Â  Â  Â  Â  Â  if (key.startsWith('turmas_') || key === 'trainers' || key === 'starts' || key === 'ends') {
Â  Â  Â  Â  Â  Â  Â  delete filters[key];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  saveFilters(filters);

Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  };

Â  Â  Â  Â  const span = document.createElement('span');
Â  Â  Â  Â  span.className = 'text';
Â  Â  Â  Â  span.textContent = client;

Â  Â  Â  Â  label.append(cb, span);
Â  Â  Â  Â  main.appendChild(label);

Â  Â  Â  Â  const archBtn = document.createElement('button');
Â  Â  Â  Â  archBtn.className = 'chip-archive';
Â  Â  Â  Â  archBtn.textContent = 'Arquivar';
Â  Â  Â  Â  archBtn.onclick = () => archiveClient(client);

Â  Â  Â  Â  item.append(main, archBtn);
Â  Â  Â  Â  list.appendChild(item);
Â  Â  Â  });
Â  Â  }

Â  Â  function renderPrograms() {
Â  Â  Â  const list = document.getElementById('programList');
Â  Â  Â  list.innerHTML = '';

Â  Â  Â  const client = getCurrentClient();
Â  Â  Â  if (!client) return;

Â  Â  Â  const f = loadFilters();
Â  Â  Â  const selected = new Set(f.programs || []);

Â  Â  Â  const programs = [...new Set(
Â  Â  Â  Â  data.filter(r => r.client === client).map(r => r.program)
Â  Â  Â  )].sort();

Â  Â  Â  programs.forEach(program => {
Â  Â  Â  Â  if (archived.programs[`${client}|${program}`]) return;

Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  item.className = 'item';

Â  Â  Â  Â  const main = document.createElement('div');
Â  Â  Â  Â  main.className = 'item-main';

Â  Â  Â  Â  const label = document.createElement('label');
Â  Â  Â  Â  const cb = document.createElement('input');
Â  Â  Â  Â  cb.type = 'checkbox';
Â  Â  Â  Â  cb.checked = selected.has(program);

Â  Â  Â  Â  cb.onchange = () => {
Â  Â  Â  Â  Â  const filters = loadFilters();
Â  Â  Â  Â  Â  const set = new Set(filters.programs || []);
Â  Â  Â  Â  Â  if (cb.checked) set.add(program);
Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  set.delete(program);
Â  Â  Â  Â  Â  Â  // Limpar filtros dinÃ¢micos especÃ­ficos do programa desmarcado
Â  Â  Â  Â  Â  Â  delete filters[`turmas_${program}`];
Â  Â  Â  Â  Â  Â  if (filters.trainers) delete filters.trainers[program];
Â  Â  Â  Â  Â  Â  if (filters.starts) delete filters.starts[program];
Â  Â  Â  Â  Â  Â  if (filters.ends) delete filters.ends[program];
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  filters.programs = [...set];
Â  Â  Â  Â  Â  saveFilters(filters);

Â  Â  Â  Â  Â  renderInfos();
Â  Â  Â  Â  Â  refreshDynamic();
Â  Â  Â  Â  Â  updateViewReportButton();
Â  Â  Â  Â  };

Â  Â  Â  Â  const span = document.createElement('span');
Â  Â  Â  Â  span.className = 'text';
Â  Â  Â  Â  span.textContent = program;

Â  Â  Â  Â  label.append(cb, span);
Â  Â  Â  Â  main.appendChild(label);

Â  Â  Â  Â  const archBtn = document.createElement('button');
Â  Â  Â  Â  archBtn.className = 'chip-archive';
Â  Â  Â  Â  archBtn.textContent = 'Arquivar';
Â  Â  Â  Â  archBtn.onclick = () => archiveProgram(client, program);

Â  Â  Â  Â  item.append(main, archBtn);
Â  Â  Â  Â  list.appendChild(item);
Â  Â  Â  });
Â  Â  }

Â  Â  function renderInfos() {
Â  Â  Â  const list = document.getElementById('infoList');
Â  Â  Â  list.innerHTML = '';

Â  Â  Â  const client = getCurrentClient();
Â  Â  Â  const f = loadFilters();
Â  Â  Â  const programs = f.programs || [];
Â  Â  Â  if (!client || !programs.length) return;

Â  Â  Â  const selected = new Set(f.clientInfos || []);

Â  Â  Â  const infos = [...new Set(
Â  Â  Â  Â  data.filter(r => r.client === client && programs.includes(r.program))
Â  Â  Â  Â  Â  Â  .map(r => r.client_info)
Â  Â  Â  )].sort();

Â  Â  Â  infos.forEach(info => {
Â  Â  Â  Â  // Verifica se estÃ¡ arquivada OU se Ã© uma das perguntas ignoradas
Â  Â  Â  Â  if (archived.infos[`${client}|${info}`] || PERGUNTAS_IGNORADAS.includes(info)) return;

Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  item.className = 'item';

Â  Â  Â  Â  const main = document.createElement('div');
Â  Â  Â  Â  main.className = 'item-main';

Â  Â  Â  Â  const label = document.createElement('label');
Â  Â  Â  Â  const cb = document.createElement('input');
Â  Â  Â  Â  cb.type = 'checkbox';
Â  Â  Â  Â  cb.checked = selected.has(info);

Â  Â  Â  Â  cb.onchange = () => {
Â  Â  Â  Â  Â  const filters = loadFilters();
Â  Â  Â  Â  Â  const set = new Set(filters.clientInfos || []);
Â  Â  Â  Â  Â  if (cb.checked) set.add(info);
Â  Â  Â  Â  Â  else set.delete(info);
Â  Â  Â  Â  Â  filters.clientInfos = [...set];
Â  Â  Â  Â  Â  saveFilters(filters);

Â  Â  Â  Â  Â  refreshDynamic();
Â  Â  Â  Â  Â  updateViewReportButton();
Â  Â  Â  Â  };

Â  Â  Â  Â  const span = document.createElement('span');
Â  Â  Â  Â  span.className = 'text';
Â  Â  Â  Â  span.textContent = info;

Â  Â  Â  Â  label.append(cb, span);
Â  Â  Â  Â  main.appendChild(label);

Â  Â  Â  Â  const archBtn = document.createElement('button');
Â  Â  Â  Â  archBtn.className = 'chip-archive';
Â  Â  Â  Â  archBtn.textContent = 'Arquivar';
Â  Â  Â  Â  archBtn.onclick = () => archiveInfo(client, info);

Â  Â  Â  Â  item.append(main, archBtn);
Â  Â  Â  Â  list.appendChild(item);
Â  Â  Â  });
Â  Â  }

Â  Â  // ====================================================
Â  Â  // BOTÃ•ES â€œSelecionar todosâ€
Â  Â  // ====================================================
Â  Â  function selectAllPrograms() {
Â  Â  Â  const client = getCurrentClient();
Â  Â  Â  if (!client) return;

Â  Â  Â  const programs = [...new Set(
Â  Â  Â  Â  data.filter(r => r.client === client).map(r => r.program)
Â  Â  Â  )].sort().filter(p => !archived.programs[`${client}|${p}`]);

Â  Â  Â  const f = loadFilters();
Â  Â  Â  const allSelected = programs.length &&
Â  Â  Â  Â  programs.every(p => (f.programs || []).includes(p));

Â  Â  Â  // Se jÃ¡ estiverem todos selecionados, desmarca. SenÃ£o, marca todos.
Â  Â  Â  f.programs = allSelected ? [] : programs;

Â  Â  Â  // Se desmarcar todos, limpa tambÃ©m os filtros dinÃ¢micos associados
Â  Â  Â  if (allSelected) {
Â  Â  Â  Â  for (const program of programs) {
Â  Â  Â  Â  Â  delete f[`turmas_${program}`];
Â  Â  Â  Â  Â  if (f.trainers) delete f.trainers[program];
Â  Â  Â  Â  Â  if (f.starts) delete f.starts[program];
Â  Â  Â  Â  Â  if (f.ends) delete f.ends[program];
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  saveFilters(f);

Â  Â  Â  renderPrograms();
Â  Â  Â  renderInfos();
Â  Â  Â  refreshDynamic();
Â  Â  Â  updateViewReportButton();
Â  Â  }

Â  Â  function selectAllInfos() {
Â  Â  Â  const client = getCurrentClient();
Â  Â  Â  if (!client) return;

Â  Â  Â  const f = loadFilters();
Â  Â  Â  const programs = f.programs || [];
Â  Â  Â  if (!programs.length) return;

Â  Â  Â  // Filtra tambÃ©m as PERGUNTAS_IGNORADAS para nÃ£o serem selecionadas
Â  Â  Â  const infos = [...new Set(
Â  Â  Â  Â  data.filter(r => r.client === client && programs.includes(r.program))
Â  Â  Â  Â  Â  Â  .map(r => r.client_info)
Â  Â  Â  )].sort().filter(info =>
Â  Â  Â  Â  !archived.infos[`${client}|${info}`] &&
Â  Â  Â  Â  !PERGUNTAS_IGNORADAS.includes(info)
Â  Â  Â  );

Â  Â  Â  const allSelected = infos.length &&
Â  Â  Â  Â  infos.every(i => (f.clientInfos || []).includes(i));

Â  Â  Â  f.clientInfos = allSelected ? [] : infos;
Â  Â  Â  saveFilters(f);

Â  Â  Â  renderInfos();
Â  Â  Â  refreshDynamic();
Â  Â  Â  updateViewReportButton();
Â  Â  }

Â  Â  // ====================================================
Â  Â  // BLOCO DINÃ‚MICO (Formador / InÃ­cio / Fim / Turmas)
Â  Â  // ====================================================
Â  Â  function createInputField(labelText, program, key) {
Â  Â  Â  const f = loadFilters();
Â  Â  Â  const container = document.createElement('div');

Â  Â  Â  const label = document.createElement('label');
Â  Â  Â  label.textContent = labelText;
Â  Â  Â  container.appendChild(label);

Â  Â  Â  const input = document.createElement('input');
Â  Â  Â  input.type = 'text';
Â  Â  Â  // Garante que o objeto existe no filtro antes de tentar aceder Ã  propriedade
Â  Â  Â  input.value = (f[key] && f[key][program]) || '';
Â  Â  Â  input.oninput = (e) => {
Â  Â  Â  Â  const filters = loadFilters();
Â  Â  Â  Â  filters[key] = filters[key] || {};
Â  Â  Â  Â  filters[key][program] = e.target.value;
Â  Â  Â  Â  saveFilters(filters);
Â  Â  Â  };

Â  Â  Â  container.appendChild(input);
Â  Â  Â  return container;
Â  Â  }

Â  Â  function createMonthField(labelText, program, key) {
Â  Â  Â  const f = loadFilters();
Â  Â  Â  const container = document.createElement('div');

Â  Â  Â  const label = document.createElement('label');
Â  Â  Â  label.textContent = labelText;
Â  Â  Â  container.appendChild(label);

Â  Â  Â  const input = document.createElement('input');
Â  Â  Â  input.type = 'month';
Â  Â  Â  input.value = (f[key] && f[key][program]) || '';
Â  Â  Â  input.onchange = (e) => {
Â  Â  Â  Â  const filters = loadFilters();
Â  Â  Â  Â  filters[key] = filters[key] || {};
Â  Â  Â  Â  filters[key][program] = e.target.value;
Â  Â  Â  Â  saveFilters(filters);
Â  Â  Â  };

Â  Â  Â  container.appendChild(input);
Â  Â  Â  return container;
Â  Â  }

Â  Â  function buildCheckboxGroup(labelText, options, key) {
Â  Â  Â  const f = loadFilters();
Â  Â  Â  const selected = new Set(f[key] || []);

Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  const title = document.createElement('h4');
Â  Â  Â  title.textContent = labelText;
Â  Â  Â  wrapper.appendChild(title);

Â  Â  Â  const list = document.createElement('ol');

Â  Â  Â  // Se nÃ£o houver turmas, mostra uma mensagem
Â  Â  Â  if (options.length === 0) {
Â  Â  Â  Â  const p = document.createElement('p');
Â  Â  Â  Â  p.style.fontSize = '12px';
Â  Â  Â  Â  p.style.color = 'var(--red)';
Â  Â  Â  Â  p.style.paddingLeft = '16px';
Â  Â  Â  Â  p.textContent = 'Sem turmas para esta seleÃ§Ã£o de Info/Data.';
Â  Â  Â  Â  wrapper.appendChild(p);
Â  Â  Â  Â  return wrapper;
Â  Â  Â  }

Â  Â  Â  options.forEach(opt => {
Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  const lab = document.createElement('label');
Â  Â  Â  Â  const cb = document.createElement('input');
Â  Â  Â  Â  cb.type = 'checkbox';
Â  Â  Â  Â  cb.value = opt;
Â  Â  Â  Â  cb.checked = selected.has(opt);

Â  Â  Â  Â  cb.onchange = () => {
Â  Â  Â  Â  Â  const filters = loadFilters();
Â  Â  Â  Â  Â  const set = new Set(filters[key] || []);
Â  Â  Â  Â  Â  if (cb.checked) set.add(opt);
Â  Â  Â  Â  Â  else set.delete(opt);
Â  Â  Â  Â  Â  filters[key] = [...set];
Â  Â  Â  Â  Â  saveFilters(filters);
Â  Â  Â  Â  };

Â  Â  Â  Â  lab.append(cb, document.createTextNode(opt));
Â  Â  Â  Â  li.appendChild(lab);
Â  Â  Â  Â  list.appendChild(li);
Â  Â  Â  });

Â  Â  Â  wrapper.appendChild(list);
Â  Â  Â  return wrapper;
Â  Â  }

Â  Â  function refreshDynamic() {
Â  Â  Â  const f = loadFilters();
Â  Â  Â  const client = (f.clients || [])[0];
Â  Â  Â  const progs = f.programs || [];
Â  Â  Â  const infos = f.clientInfos || [];

Â  Â  Â  const db = document.getElementById('dynamicBlocks');
Â  Â  Â  db.innerHTML = '';

Â  Â  Â  const btn = document.getElementById('viewReport');
Â  Â  Â  const enabled = client && progs.length && infos.length;
Â  Â  Â  btn.disabled = !enabled;
Â  Â  Â  btn.classList.toggle('enabled', enabled);

Â  Â  Â  if (!enabled) return;

Â  Â  Â  progs.forEach(program => {
Â  Â  Â  Â  const block = document.createElement('div');
Â  Â  Â  Â  block.className = 'dynamic-block';

Â  Â  Â  Â  const h3 = document.createElement('h3');
Â  Â  Â  Â  h3.textContent = `Programa: ${program}`;
Â  Â  Â  Â  block.appendChild(h3);

Â  Â  Â  Â  block.appendChild(createInputField('Formador', program, 'trainers'));
Â  Â  Â  Â  block.appendChild(createMonthField('InÃ­cio', program, 'starts'));
Â  Â  Â  Â  block.appendChild(createMonthField('Fim', program, 'ends'));

Â  Â  Â  Â  // Turmas filtradas por client + programa + infos seleccionadas
Â  Â  Â  Â  const turmas = [...new Set(
Â  Â  Â  Â  Â  data.filter(d =>
Â  Â  Â  Â  Â  Â  d.client === client &&
Â  Â  Â  Â  Â  Â  d.program === program &&
Â  Â  Â  Â  Â  Â  infos.includes(d.client_info)
Â  Â  Â  Â  Â  ).map(d => d.turma)
Â  Â  Â  Â  )].sort();

Â  Â  Â  Â  const key = `turmas_${program}`;
Â  Â  Â  Â  block.appendChild(buildCheckboxGroup('Turmas', turmas, key));

Â  Â  Â  Â  db.appendChild(block);
Â  Â  Â  });
Â  Â  }

Â  Â  function updateViewReportButton() {
Â  Â  Â  refreshDynamic(); // jÃ¡ trata do botÃ£o
Â  Â  }

Â  Â  // ====================================================
Â  Â  // ARQUIVAR / DESARQUIVAR
Â  Â  // ====================================================
Â  Â  function archiveClient(client) {
Â  Â  Â  customConfirm(
Â  Â  Â  Â  'ConfirmaÃ§Ã£o de Arquivamento',
Â  Â  Â  Â  `Tem a certeza que deseja arquivar o cliente "${client}"? Ele serÃ¡ escondido das listas.`,
Â  Â  Â  Â  (confirmed) => {
Â  Â  Â  Â  Â  if (!confirmed) return;

Â  Â  Â  Â  Â  archived.clients[client] = true;

Â  Â  Â  Â  Â  // Se for o cliente selecionado, limpa seleÃ§Ã£o
Â  Â  Â  Â  Â  const f = loadFilters();
Â  Â  Â  Â  Â  if ((f.clients || [])[0] === client) {
Â  Â  Â  Â  Â  Â  f.clients = [];
Â  Â  Â  Â  Â  Â  f.programs = [];
Â  Â  Â  Â  Â  Â  f.clientInfos = [];
Â  Â  Â  Â  Â  Â  saveFilters(f);
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  Â  updateArchivedUI();
Â  Â  Â  Â  Â  saveArchivedState();
Â  Â  Â  Â  }
Â  Â  Â  );
Â  Â  }

Â  Â  function archiveProgram(client, program) {
Â  Â  Â  customConfirm(
Â  Â  Â  Â  'ConfirmaÃ§Ã£o de Arquivamento',
Â  Â  Â  Â  `Tem a certeza que deseja arquivar o programa "${program}" para o cliente "${client}"?`,
Â  Â  Â  Â  (confirmed) => {
Â  Â  Â  Â  Â  if (!confirmed) return;

Â  Â  Â  Â  Â  archived.programs[`${client}|${program}`] = true;

Â  Â  Â  Â  Â  const f = loadFilters();
Â  Â  Â  Â  Â  f.programs = (f.programs || []).filter(p => p !== program);
Â  Â  Â  Â  Â  saveFilters(f);

Â  Â  Â  Â  Â  renderPrograms();
Â  Â  Â  Â  Â  renderInfos();
Â  Â  Â  Â  Â  refreshDynamic();
Â  Â  Â  Â  Â  updateArchivedUI();
Â  Â  Â  Â  Â  saveArchivedState();
Â  Â  Â  Â  }
Â  Â  Â  );
Â  Â  }

Â  Â  function archiveInfo(client, info) {
Â  Â  Â  customConfirm(
Â  Â  Â  Â  'ConfirmaÃ§Ã£o de Arquivamento',
Â  Â  Â  Â  `Tem a certeza que deseja arquivar a info "${info}" para o cliente "${client}"?`,
Â  Â  Â  Â  (confirmed) => {
Â  Â  Â  Â  Â  if (!confirmed) return;

Â  Â  Â  Â  Â  archived.infos[`${client}|${info}`] = true;

Â  Â  Â  Â  Â  const f = loadFilters();
Â  Â  Â  Â  Â  f.clientInfos = (f.clientInfos || []).filter(i => i !== info);
Â  Â  Â  Â  Â  saveFilters(f);

Â  Â  Â  Â  Â  renderInfos();
Â  Â  Â  Â  Â  refreshDynamic();
Â  Â  Â  Â  Â  updateArchivedUI();
Â  Â  Â  Â  Â  saveArchivedState();
Â  Â  Â  Â  }
Â  Â  Â  );
Â  Â  }

Â  Â  function unarchiveClient(client) {
Â  Â  Â  delete archived.clients[client];
Â  Â  Â  renderAll();
Â  Â  Â  updateArchivedUI();
Â  Â  Â  saveArchivedState();
Â  Â  }

Â  Â  function unarchiveProgram(client, program) {
Â  Â  Â  delete archived.programs[`${client}|${program}`];
Â  Â  Â  renderPrograms();
Â  Â  Â  updateArchivedUI();
Â  Â  Â  saveArchivedState();
Â  Â  }

Â  Â  function unarchiveInfo(client, info) {
Â  Â  Â  delete archived.infos[`${client}|${info}`];
Â  Â  Â  renderInfos();
Â  Â  Â  updateArchivedUI();
Â  Â  Â  saveArchivedState();
Â  Â  }

Â  Â  // ====================================================
Â  Â  // UI ARQUIVADOS AGRUPADA POR CLIENTE
Â  Â  // ====================================================
Â  Â  function updateArchivedUI() {
Â  Â  Â  const clientsArchived = Object.keys(archived.clients);
Â  Â  Â  const programsArchived = Object.keys(archived.programs); // "CLIENT|PROG"
Â  Â  Â  const infosArchived = Object.keys(archived.infos);Â  Â  Â  Â // "CLIENT|INFO"

Â  Â  Â  const total =
Â  Â  Â  Â  clientsArchived.length + programsArchived.length + infosArchived.length;
Â  Â  Â  document.getElementById('archivedCount').textContent = total;

Â  Â  Â  const content = document.getElementById('archivedContent');
Â  Â  Â  content.innerHTML = '';

Â  Â  Â  if (total === 0) {
Â  Â  Â  Â  content.textContent = 'Nenhum item arquivado.';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Agrupar por cliente
Â  Â  Â  const grouped = {}; // { CLIENTE: { clientArchived, programs:[], infos:[] } }

Â  Â  Â  clientsArchived.forEach(c => {
Â  Â  Â  Â  if (!grouped[c]) grouped[c] = { clientArchived: false, programs: [], infos: [] };
Â  Â  Â  Â  grouped[c].clientArchived = true;
Â  Â  Â  });

Â  Â  Â  programsArchived.forEach(key => {
Â  Â  Â  Â  const [client, program] = key.split('|');
Â  Â  Â  Â  if (!grouped[client]) grouped[client] = { clientArchived: false, programs: [], infos: [] };
Â  Â  Â  Â  if (!grouped[client].programs.includes(program)) {
Â  Â  Â  Â  Â  grouped[client].programs.push(program);
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  infosArchived.forEach(key => {
Â  Â  Â  Â  const [client, info] = key.split('|');
Â  Â  Â  Â  if (!grouped[client]) grouped[client] = { clientArchived: false, programs: [], infos: [] };
Â  Â  Â  Â  if (!grouped[client].infos.includes(info)) {
Â  Â  Â  Â  Â  grouped[client].infos.push(info);
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // Filtro por cliente
Â  Â  Â  const filterInput = document.getElementById('archivedFilter');
Â  Â  Â  const term = (filterInput?.value || '').trim().toLowerCase();

Â  Â  Â  const sortedClients = Object.keys(grouped).sort((a, b) =>
Â  Â  Â  Â  a.localeCompare(b, 'pt', { sensitivity: 'base' })
Â  Â  Â  );

Â  Â  Â  sortedClients.forEach(client => {
Â  Â  Â  Â  if (term && !client.toLowerCase().includes(term)) return;

Â  Â  Â  Â  const g = grouped[client];
Â  Â  Â  Â  const hasPrograms = g.programs.length > 0;
Â  Â  Â  Â  const hasInfos = g.infos.length > 0;
Â  Â  Â  Â  const hasSomething = g.clientArchived || hasPrograms || hasInfos;
Â  Â  Â  Â  if (!hasSomething) return;

Â  Â  Â  Â  const block = document.createElement('div');
Â  Â  Â  Â  block.className = 'archived-list-group';
Â  Â  Â  Â  block.style.marginBottom = '8px';

Â  Â  Â  Â  // CabeÃ§alho do cliente
Â  Â  Â  Â  const header = document.createElement('div');
Â  Â  Â  Â  header.style.display = 'flex';
Â  Â  Â  Â  header.style.alignItems = 'center';
Â  Â  Â  Â  header.style.justifyContent = 'space-between';
Â  Â  Â  Â  header.style.marginBottom = '4px';

Â  Â  Â  Â  const title = document.createElement('strong');
Â  Â  Â  Â  title.style.fontSize = '11px';
Â  Â  Â  Â  title.style.textTransform = 'uppercase';
Â  Â  Â  Â  title.style.letterSpacing = '0.08em';
Â  Â  Â  Â  title.style.color = 'var(--text-muted)';
Â  Â  Â  Â  title.textContent = client;

Â  Â  Â  Â  header.appendChild(title);

Â  Â  Â  Â  // Cliente inteiro arquivado
Â  Â  Â  Â  if (g.clientArchived) {
Â  Â  Â  Â  Â  const clientTag = document.createElement('span');
Â  Â  Â  Â  Â  clientTag.className = 'tag';
Â  Â  Â  Â  Â  clientTag.style.marginLeft = '8px';
Â  Â  Â  Â  Â  clientTag.innerHTML = `Cliente arquivado <span title="Desarquivar cliente">Ã—</span>`;
Â  Â  Â  Â  Â  clientTag.querySelector('span').onclick = () => unarchiveClient(client);
Â  Â  Â  Â  Â  header.appendChild(clientTag);
Â  Â  Â  Â  }

Â  Â  Â  Â  block.appendChild(header);

Â  Â  Â  Â  // Programas
Â  Â  Â  Â  if (hasPrograms) {
Â  Â  Â  Â  Â  const labelProg = document.createElement('div');
Â  Â  Â  Â  Â  labelProg.style.fontSize = '11px';
Â  Â  Â  Â  Â  labelProg.style.color = 'var(--text-muted)';
Â  Â  Â  Â  Â  labelProg.textContent = 'Programas:';
Â  Â  Â  Â  Â  block.appendChild(labelProg);

Â  Â  Â  Â  Â  const tagsProg = document.createElement('div');
Â  Â  Â  Â  Â  tagsProg.className = 'archived-tags';

Â  Â  Â  Â  Â  g.programs.forEach(program => {
Â  Â  Â  Â  Â  Â  const tag = document.createElement('span');
Â  Â  Â  Â  Â  Â  tag.className = 'tag';
Â  Â  Â  Â  Â  Â  tag.innerHTML = `${program} <span title="Desarquivar programa">Ã—</span>`;
Â  Â  Â  Â  Â  Â  tag.querySelector('span').onclick = () => unarchiveProgram(client, program);
Â  Â  Â  Â  Â  Â  tagsProg.appendChild(tag);
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  block.appendChild(tagsProg);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Infos / Datas
Â  Â  Â  Â  if (hasInfos) {
Â  Â  Â  Â  Â  const labelInfo = document.createElement('div');
Â  Â  Â  Â  Â  labelInfo.style.fontSize = '11px';
Â  Â  Â  Â  Â  labelInfo.style.color = 'var(--text-muted)';
Â  Â  Â  Â  Â  labelInfo.style.marginTop = '4px';
Â  Â  Â  Â  Â  labelInfo.textContent = 'Infos / Datas:';
Â  Â  Â  Â  Â  block.appendChild(labelInfo);

Â  Â  Â  Â  Â  const tagsInfo = document.createElement('div');
Â  Â  Â  Â  Â  tagsInfo.className = 'archived-tags';

Â  Â  Â  Â  Â  g.infos.forEach(info => {
Â  Â  Â  Â  Â  Â  const tag = document.createElement('span');
Â  Â  Â  Â  Â  Â  tag.className = 'tag';
Â  Â  Â  Â  Â  Â  tag.innerHTML = `${info} <span title="Desarquivar info">Ã—</span>`;
Â  Â  Â  Â  Â  Â  tag.querySelector('span').onclick = () => unarchiveInfo(client, info);
Â  Â  Â  Â  Â  Â  tagsInfo.appendChild(tag);
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  block.appendChild(tagsInfo);
Â  Â  Â  Â  }

Â  Â  Â  Â  content.appendChild(block);
Â  Â  Â  });
Â  Â  }

Â  Â  function toggleArchivedPanel() {
Â  Â  Â  const panel = document.getElementById('archivedPanel');
Â  Â  Â  panel.classList.toggle('visible');
Â  Â  }

Â  Â  // ====================================================
Â  Â  // VER RELATÃ“RIO
Â  Â  // ====================================================
Â  Â  function applyAndGo() {
Â  Â  Â  const all = loadFilters();
Â  Â  Â  
Â  Â  Â  // --- LÃ“GICA DE LIMPEZA (SANITIZATION) ---
Â  Â  Â  
Â  Â  Â  // 1. Remover perguntas explicitamente ignoradas
Â  Â  Â  if (all.clientInfos && Array.isArray(all.clientInfos)) {
Â  Â  Â  Â  all.clientInfos = all.clientInfos.filter(info => 
Â  Â  Â  Â  Â  !PERGUNTAS_IGNORADAS.includes(info)
Â  Â  Â  Â  );
Â  Â  Â  }

Â  Â  Â  // 2. Remover turmas, formadores e datas de programas que nÃ£o estÃ£o ativos
Â  Â  Â  const activePrograms = all.programs || [];
Â  Â  Â  
Â  Â  Â  // Limpar chaves 'turmas_PROGRAMA' Ã³rfÃ£s
Â  Â  Â  Object.keys(all).forEach(key => {
Â  Â  Â  Â  if (key.startsWith('turmas_')) {
Â  Â  Â  Â  Â  const prog = key.replace('turmas_', '');
Â  Â  Â  Â  Â  if (!activePrograms.includes(prog)) {
Â  Â  Â  Â  Â  Â  delete all[key];
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // Limpar campos aninhados de formadores/datas
Â  Â  Â  ['trainers', 'starts', 'ends'].forEach(field => {
Â  Â  Â  Â  if (all[field]) {
Â  Â  Â  Â  Â  Object.keys(all[field]).forEach(prog => {
Â  Â  Â  Â  Â  Â  if (!activePrograms.includes(prog)) {
Â  Â  Â  Â  Â  Â  Â  delete all[field][prog];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // Guarda a versÃ£o limpa
Â  Â  Â  localStorage.setItem('reportFilters', JSON.stringify(all));
Â  Â  Â  
Â  Â  Â  customAlert(
Â  Â  Â  Â  'Filtros Prontos',
Â  Â  Â  Â  'Os filtros foram limpos (perguntas ignoradas removidas) e guardados em localStorage ("reportFilters"). O prÃ³ximo passo seria o redirecionamento para o report.html.'
Â  Â  Â  );
Â  Â  }

Â  Â  // ====================================================
Â  Â  // INIT
Â  Â  // ====================================================
Â  Â  function renderAll() {
Â  Â  Â  renderClients();
Â  Â  Â  renderPrograms();
Â  Â  Â  renderInfos();
Â  Â  Â  refreshDynamic();
Â  Â  }

Â  Â  async function init() {
      // Carregar lista de perguntas ignoradas via CSV (se configurado)
      await loadIgnoredQuestions();

Â  Â  Â  // 1. Carregar data.json
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch('data.json');
Â  Â  Â  Â  if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  data = await response.json();
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Erro a carregar data.json:', err);
Â  Â  Â  Â  customAlert('Erro de Carregamento', 'NÃ£o foi possÃ­vel carregar o ficheiro de dados (data.json). Verifique o caminho ou o conteÃºdo.');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // 2. Carregar estado arquivado
Â  Â  Â  archived = await loadArchivedState();
Â  Â  Â  
Â  Â  Â  // 3. Renderizar UI
Â  Â  Â  renderAll();
Â  Â  Â  updateArchivedUI();

Â  Â  Â  // 4. Adicionar Listeners
Â  Â  Â  document.getElementById('btnSelectAllPrograms').onclick = selectAllPrograms;
Â  Â  Â  document.getElementById('btnSelectAllInfos').onclick = selectAllInfos;
Â  Â  Â  
Â  Â  Â  // Toggle do painel de arquivados por ambos os botÃµes
Â  Â  Â  document.getElementById('btnToggleArchived').onclick = toggleArchivedPanel;
Â  Â  Â  document.getElementById('btnToggleArchivedPill').onclick = toggleArchivedPanel;
Â  Â  Â  
Â  Â  Â  document.getElementById('viewReport').onclick = applyAndGo;

Â  Â  Â  const filter = document.getElementById('archivedFilter');
Â  Â  Â  if (filter) {
Â  Â  Â  Â  filter.addEventListener('input', updateArchivedUI);
Â  Â  Â  }

Â  Â  Â  // Fechar painel arquivados ao clicar fora
Â  Â  Â  document.addEventListener('click', (e) => {
Â  Â  Â  Â  const panel = document.getElementById('archivedPanel');
Â  Â  Â  Â  const toggleBtn = document.getElementById('btnToggleArchived');
Â  Â  Â  Â  const togglePill = document.getElementById('btnToggleArchivedPill');

Â  Â  Â  Â  if (!panel.classList.contains('visible')) return;
Â  Â  Â  Â  
Â  Â  Â  Â  // Verifica se o clique foi fora do painel E fora dos botÃµes de toggle
Â  Â  Â  Â  if (!panel.contains(e.target) && !toggleBtn.contains(e.target) && !togglePill.contains(e.target)) {
Â  Â  Â  Â  Â  panel.classList.remove('visible');
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  document.addEventListener('DOMContentLoaded', init);
Â  </script>
</body>
</html>
